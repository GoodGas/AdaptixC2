name: Daily Update and Build (Debug Version)

on:
  schedule:
    - cron: '0 16 * * *'  # UTC 16:00 = åŒ—äº¬æ—¶é—´ 24:00
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶æž„å»ºï¼ˆå³ä½¿æ²¡æœ‰æ›´æ–°ï¼‰'
        required: false
        type: boolean
        default: false

env:
  UPSTREAM_REPO: Adaptix-Framework/AdaptixC2
  UPSTREAM_BRANCH: main

jobs:
  check-and-sync:
    name: Check for updates and sync
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check_updates.outputs.has_updates }}
      commit_message: ${{ steps.check_updates.outputs.commit_message }}
      commits_behind: ${{ steps.check_updates.outputs.commits_behind }}
      local_commit: ${{ steps.check_updates.outputs.local_commit }}
      upstream_commit: ${{ steps.check_updates.outputs.upstream_commit }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Check for upstream updates
      id: check_updates
      run: |
        # æ·»åŠ ä¸Šæ¸¸ä»“åº“
        git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
        git fetch upstream ${{ env.UPSTREAM_BRANCH }}
        
        # èŽ·å–å½“å‰å’Œä¸Šæ¸¸çš„ commit hash
        LOCAL_COMMIT=$(git rev-parse HEAD)
        UPSTREAM_COMMIT=$(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})
        
        # ä¿å­˜ commit ä¿¡æ¯
        echo "local_commit=$LOCAL_COMMIT" >> $GITHUB_OUTPUT
        echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
        
        # è®¡ç®—è½åŽçš„æäº¤æ•°
        COMMITS_BEHIND=$(git rev-list --count HEAD..upstream/${{ env.UPSTREAM_BRANCH }})
        
        echo "=== è°ƒè¯•ä¿¡æ¯ ===" 
        echo "Local commit: $LOCAL_COMMIT"
        echo "Upstream commit: $UPSTREAM_COMMIT"
        echo "Commits behind: $COMMITS_BEHIND"
        echo "Force build: ${{ github.event.inputs.force_build }}"
        
        # æ˜¾ç¤ºæœ€è¿‘çš„æäº¤åŽ†å²
        echo ""
        echo "=== æœ¬åœ°æœ€è¿‘5ä¸ªæäº¤ ==="
        git log --oneline -5
        
        echo ""
        echo "=== ä¸Šæ¸¸æœ€è¿‘5ä¸ªæäº¤ ==="
        git log upstream/${{ env.UPSTREAM_BRANCH }} --oneline -5
        
        if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "commits_behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
          
          # èŽ·å–æœ€æ–°çš„æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log upstream/${{ env.UPSTREAM_BRANCH }} -1 --pretty=format:"%s")
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          
          echo "### âœ… æ£€æµ‹åˆ°ä¸Šæ¸¸æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æœ¬åœ° commit**: $LOCAL_COMMIT" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¸Šæ¸¸ commit**: $UPSTREAM_COMMIT" >> $GITHUB_STEP_SUMMARY
          echo "- **è½åŽæäº¤æ•°**: $COMMITS_BEHIND" >> $GITHUB_STEP_SUMMARY
          echo "- **æœ€æ–°æäº¤**: $COMMIT_MSG" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºå…·ä½“çš„å·®å¼‚
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ æäº¤å·®å¼‚" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git log --oneline HEAD..upstream/${{ env.UPSTREAM_BRANCH }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
          echo "commits_behind=0" >> $GITHUB_OUTPUT
          echo "### â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–°çš„æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **å½“å‰ commit**: $LOCAL_COMMIT" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‚¨çš„ä»“åº“å·²æ˜¯æœ€æ–°ç‰ˆæœ¬**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # å¦‚æžœæ˜¯å¼ºåˆ¶æž„å»º
        if [ "${{ github.event.inputs.force_build }}" == "true" ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ å¼ºåˆ¶æž„å»ºæ¨¡å¼" >> $GITHUB_STEP_SUMMARY
          echo "å³ä½¿æ²¡æœ‰æ›´æ–°ä¹Ÿä¼šæ‰§è¡Œæž„å»º" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Sync with upstream
      if: steps.check_updates.outputs.has_updates == 'true' && steps.check_updates.outputs.local_commit != steps.check_updates.outputs.upstream_commit
      run: |
        echo "=== å¼€å§‹åŒæ­¥ä¸Šæ¸¸æ›´æ”¹ ==="
        # åˆå¹¶ä¸Šæ¸¸æ›´æ”¹
        if git merge upstream/${{ env.UPSTREAM_BRANCH }} --no-edit; then
          echo "âœ… æˆåŠŸåˆå¹¶ä¸Šæ¸¸æ›´æ”¹"
          git push origin ${{ github.ref_name }}
        else
          echo "âŒ åˆå¹¶æ—¶å‡ºçŽ°å†²çª"
          git status
          exit 1
        fi

  build-all:
    name: Build all platforms
    needs: check-and-sync
    if: needs.check-and-sync.outputs.has_updates == 'true'
    uses: ./.github/workflows/build.yml
    secrets: inherit

  create-report:
    name: Create daily report
    needs: [check-and-sync, build-all]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Create detailed report
      run: |
        echo "# ðŸ“Š æ¯æ—¥è‡ªåŠ¨æ›´æ–°å’Œæž„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.check-and-sync.outputs.has_updates }}" == "true" ]; then
          echo "## âœ… æ›´æ–°çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- æ£€æµ‹åˆ°ä¸Šæ¸¸æ›´æ–°æˆ–å¼ºåˆ¶æž„å»º" >> $GITHUB_STEP_SUMMARY
          echo "- æœ¬åœ° commit: \`${{ needs.check-and-sync.outputs.local_commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ä¸Šæ¸¸ commit: \`${{ needs.check-and-sync.outputs.upstream_commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- è½åŽæäº¤æ•°: ${{ needs.check-and-sync.outputs.commits_behind }}" >> $GITHUB_STEP_SUMMARY
          echo "- æœ€æ–°æäº¤: ${{ needs.check-and-sync.outputs.commit_message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-all.result }}" == "success" ]; then
            echo "## ðŸŽ‰ æž„å»ºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æ‰€æœ‰å¹³å°æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-all.result }}" == "failure" ]; then
            echo "## âŒ æž„å»ºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
            echo "- âš ï¸ æž„å»ºè¿‡ç¨‹ä¸­å‡ºçŽ°é”™è¯¯" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-all.result }}" == "skipped" ]; then
            echo "## â­ï¸ æž„å»ºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
            echo "- æž„å»ºè¢«è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## â„¹ï¸ æ— æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- æ‚¨çš„ä»“åº“å·²æ˜¯æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "- ä¸‹æ¬¡æ£€æŸ¥æ—¶é—´: æ˜Žæ—¥åŒä¸€æ—¶é—´" >> $GITHUB_STEP_SUMMARY
        fi
